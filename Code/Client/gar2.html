<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAR Report</title>
    <style>
        .container { padding: 20px; }
        .filter-form { 
            margin-bottom: 20px; 
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .filter-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background-color: #f4f4f4; }
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            cursor: pointer;
        }
    </style>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.2.1/exceljs.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
   

</head>
<body>
    <div class="container">
        <h1>General Attendance Report</h1>
        
        <!-- Debug Toggle Button -->
        <button id="debugToggle" onclick="toggleDebugLog()" style="display: block;">Toggle Debug Log</button>
        
        <!-- Debug Log Panel -->
        <div id="debugLog" class="debug-log" style="display: block;">
            <h3>Debug Log:</h3>
            <pre id="debugOutput"></pre>
        </div>

        <!-- Error Message Display -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div class="filter-form">
            <div class="filter-group">
                <div class="filter-item">
                    <label for="dateFrom">Date From:</label>
                    <input type="date" id="dateFrom" name="dateFrom">
                </div>
                <div class="filter-item">
                    <label for="dateTo">Date To:</label>
                    <input type="date" id="dateTo" name="dateTo">
                </div>
                <div class="filter-item">
                    <label for="empId">Employee ID:</label>
                    <input type="text" id="empId" name="empId" placeholder="Enter employee ID">
                </div>
                <div class="filter-item">
                    <label for="empName">Employee Name:</label>
                    <input type="text" id="empName" name="empName" placeholder="Enter employee name">
                </div>
            </div>
            <div class="filter-group">
                <div class="filter-item">
                    <label for="department">Department:</label>
                    <select id="department" name="department">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="site">Site:</label>
                    <select id="site" name="site">
                        <option value="">All Sites</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="nationality">Nationality:</label>
                    <select id="nationality" name="nationality">
                        <option value="">All Nationalities</option>
                    </select>
                </div>
            </div>
            <div class="filter-buttons">
                <button id="fetchReport">Apply Filters</button>
                <button id="resetFilters">Reset Filters</button>
                <button style="display: none;" id="printButton" onclick="printDivAsPDF('reportDataContainer')">Print Report As PDF</button>
                <button style="display: none;" id="btn-export">Print Report as XLSX(Excel)</button>
                <button id="triggerSync">Refresh Data</button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner">
            Loading... Please wait...
        </div>
<!-- Add below the reportContainer div -->
<div id="paginationControls" class="pagination-controls" style="display: none;">
    <button id="prevPage">Previous</button>
    <span>Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
    <button id="nextPage">Next</button>
    <p> Jump to Page </p>
    <input type="number" id="jumpPageInput" min="1" placeholder="Page No." style="width: 50px;">
    <button id="jumpPageButton">Go</button>
</div>

<div id="reportDataContainer">
            <div>  
<img sizes="50px" width="800px" height="160px" src="Images\Logo\Company Logo.png" alt="FEDERAL ELECTRIC Company Logo">
<h1>FEDERAL ELECTRIC</h1>
<p > PO BOX 9769,Mussafah, Abu Dhabi, UAE.                                  </p>
<p >  Contact Numbers: +971 2 5592229 / 5512788                             </p>
<p >  Email: info@federalelectricals.com Website: www.federalelectricals.com</p>
<br>
<h3>Biometric attendance System</h3>
<br>
<h2 style="text-align: center; margin-top: 20px; margin-bottom: 20px; font-weight: bold; font-size: 20px; 
color: black; font-family: Arial, sans-serif; text-transform: uppercase; ">GENERAL ATTENDANCE REPORT</h2>

            </div>
        <div id="reportContainer"></div>
            
    </div>

    <script>


        // Debug logging function
        function logDebug(message, data = null) {
            const timestamp = new Date().toISOString();
            let logMessage = `[${timestamp}] ${message}`;
            if (data) {
                logMessage += '\nData: ' + JSON.stringify(data, null, 2);
            }
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.innerHTML += logMessage + '\n\n';
            console.log(logMessage);
        }

        // Error handling function
        function showError(message, error = null) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `Error: ${message}`;
            if (error) {
                errorDiv.innerHTML += `<br>Details: ${error.message}`;
                logDebug('Error occurred', { message, error: error.message });
            }
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Toggle debug log visibility
        function toggleDebugLog() {
            const debugLog = document.getElementById('debugLog');
            debugLog.style.display = debugLog.style.display === 'none' ? 'block' : 'none';
        }

        // Load dropdown options when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            logDebug('Page loaded, initializing...');
            try {
                await loadFilterOptions();
                // Load initial data without filters
                await fetchGARReport();
            } catch (error) {
                showError('Failed to initialize page', error);
            }
        });

        async function loadFilterOptions() {
            logDebug('Loading filter options');
            try {
                const response = await fetch('/api/filter-options');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                logDebug('Received filter options', data);
                
                await populateSelect('department', data.departments);
                await populateSelect('site', data.sites);
                await populateSelect('nationality', data.nationalities);
                
                logDebug('Filter options loaded successfully');
            } catch (error) {
                showError('Error loading filter options', error);
            }
        }

        async function populateSelect(id, options) {
            logDebug(`Populating ${id} dropdown`, options);
            const select = document.getElementById(id);
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.id;
                opt.textContent = option.name;
                select.appendChild(opt);
            });
        }

        document.getElementById('fetchReport').addEventListener('click', () => {
            logDebug('Fetch report button clicked');
            fetchGARReport();
        });

        document.getElementById('resetFilters').addEventListener('click', () => {
            logDebug('Reset filters button clicked');
            resetFilters();
        });

        function resetFilters() {
            logDebug('Resetting all filters');
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('empId').value = '';
            document.getElementById('empName').value = '';
            document.getElementById('department').value = '';
            document.getElementById('site').value = '';
            document.getElementById('nationality').value = '';
            
            // Fetch report without filters after reset
            fetchGARReport();
        }


  /*     
        async function fetchGARReport() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            loadingSpinner.style.display = 'block';
            logDebug('Fetching report.........................');
            try {
                const filters = {
                    dateFrom: document.getElementById('dateFrom').value,
                    dateTo: document.getElementById('dateTo').value,
                    empId: document.getElementById('empId').value,
                    empName: document.getElementById('empName').value,
                    department: document.getElementById('department').value,
                    site: document.getElementById('site').value,
                    nationality: document.getElementById('nationality').value
                };

                logDebug('Fetching report with filters', filters);

                // Only include non-empty filters in the query string
                const queryString = new URLSearchParams(
                    Object.fromEntries(
                        Object.entries(filters).filter(([_, v]) => v !== '')
                    )
                ).toString();

                logDebug('Generated query string', queryString);

                const response = await fetch(`/api/attendance-report${queryString ? `?${queryString}` : ''}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                logDebug('Received report data', data);

                displayReport(data);
                document.getElementById('printButton').style.display = 'block';
                document.getElementById('btn-export').style.display = 'block';
                document.getElementById('paginationControls').style.display = 'block';
                logDebug('Report displayed successfully');
            } catch (error) {
                showError('Error fetching report', error);
                document.getElementById('reportContainer').innerHTML = '<p>Error fetching report. Please try again.</p>';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
*/









async function fetchGARReport() {
    const loadingSpinner = document.getElementById('loadingSpinner');
    loadingSpinner.style.display = 'block';
    logDebug('Fetching report.........................');
    try {
        // Retrieve filter values with null-safe checks
        const dateFromElement = document.getElementById('dateFrom');
        const dateToElement = document.getElementById('dateTo');
        const empIdElement = document.getElementById('empId');
        const empNameElement = document.getElementById('empName');
        const departmentElement = document.getElementById('department');
        const siteElement = document.getElementById('site');
        const nationalityElement = document.getElementById('nationality');

        // Ensure all elements exist
        if (!dateFromElement || !dateToElement || !empIdElement || !empNameElement || !departmentElement || !siteElement || !nationalityElement) {
            throw new Error('One or more filter elements are missing in the DOM.');
        }

        const filters = {
            dateFrom: dateFromElement.value || '',
            dateTo: dateToElement.value || '',
            empId: empIdElement.value || '',
            empName: empNameElement.value || '',
            department: departmentElement.value || '',
            site: siteElement.value || '',
            nationality: nationalityElement.value || ''
        };

        logDebug('Fetching report with filters', filters);

        // Only include non-empty filters in the query string
        const queryString = new URLSearchParams(
            Object.fromEntries(
                Object.entries(filters).filter(([_, v]) => v !== '')
            )
        ).toString();

        logDebug('Generated query string', queryString);

        const response = await fetch(`/api/attendance-report${queryString ? `?${queryString}` : ''}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Validate the structure of the received data
        if (!data || typeof data !== 'object') {
            throw new Error('Received invalid data format from the server.');
        }

        if (!('recordCount' in data) || !('totalRecords' in data) || !('data' in data)) {
            throw new Error('Incomplete data received from the server.');
        }

        logDebug('Received report data', data);

        displayReport(data);
        document.getElementById('printButton').style.display = 'block';
        document.getElementById('btn-export').style.display = 'block';
        document.getElementById('paginationControls').style.display = 'block';
        logDebug('Report displayed successfully');
    } catch (error) {
        showError('Error fetching report', error.message);
        document.getElementById('reportContainer').innerHTML = '<p>Error fetching report. Please try again.</p>';
        logDebug('Error fetching report details', error);
    } finally {
        loadingSpinner.style.display = 'none';
    }
}





        // Validate date range
        function validateDateRange(dateFrom, dateTo) {
            if (dateFrom && dateTo) {
                const fromDate = new Date(dateFrom);
                const toDate = new Date(dateTo);
                if (fromDate > toDate) {
                    showError('Date From cannot be later than Date To');
                    return false;
                }
            }
            return true;
        }



function displayReport(data) {
    console.log(data);
    const container = document.getElementById('reportContainer');
    if (Object.keys(data).length === 0) {
        container.innerHTML = '<p>No data available.</p>';
        return;
    }

    let html = '';

    for (const [shiftId, shiftData] of Object.entries(data)) {
        console.log(shiftData);
        html += `
            <h2 style="color: red;">&nbsp;&nbsp;Shift: ${shiftData.shift_name}</h2>
            <table>
                <tr>
                    <th>Shift Type</th>
                    <th>Shift Start</th>
                    <th>Shift End</th>
                    <th>Break Hours</th>
                    <th>Time allowed before shift</th>
                    <th>Shift Incharge id</th>
                    <th>Total Working Hours Before</th>
                    <th>LGT in Minutes</th>
                </tr>
                <tr>
                    <td>${shiftData.shift_type}</td>
                    <td>${shiftData.shift_start}</td>
                    <td>${shiftData.shift_end}</td>
                    <td>${shiftData.hours_allowed_for_break}</td>
                    <td>${shiftData.time_allowed_before_shift}</td>
                    <td>${shiftData.shift_incharge}</td>
                    <td>${shiftData.total_working_hours_before}</td>
                    <td>${shiftData.lgt_in_minutes}</td>
                </tr>
            </table>
        `;

        for (const [siteId, siteData] of Object.entries(shiftData.sites)) {
            html += `<h3 style="color: blue;">&nbsp;&nbsp;Site: ${siteData.site_name}</h3>`;

            for (const [depId, depData] of Object.entries(siteData.departments)) {
                html += `<h4 style="color: green;">&nbsp;&nbsp;Department: ${depData.department_name}</h4>`;
                html += `
                    <table>
                        <thead>
                            <tr>
                                <th>Emp. ID</th>
                                <th>Emp. Name</th>
                                <th>Grade</th>
                                <th>Designation</th>
                                <th>Date</th>
                                <th>First In</th>
                                <th>Last Out</th>
                                <th>Status</th>
                                <th>AWH</th>
                                <th>OT</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const [empId, empData] of Object.entries(depData.employees)) {
                    empData.attendance.forEach((record, index) => {
                        let newawh1 = Math.floor(record.awh);
                        let newawh2 = Math.floor((record.awh % 1) * 100);
                        if (isNaN(newawh1) || isNaN(newawh2)) {
                            newawh1 = 0;
                            newawh2 = 0;
                        }

                        let newot1 = Math.floor(record.ot);
                        let newot2 = Math.floor((record.ot % 1) * 100);
                        if (isNaN(newot1) || isNaN(newot2)) {
                            newot1 = 0;
                            newot2 = 0;
                        }
                        let firstIn = record.first_in == "Invalid date" || record.first_in === null || record.first_in === '00:00:00' ? "Didn't clock in" : record.first_in;
                        let lastOut = record.last_out == "Invalid date" || record.last_out === null || record.last_out === '00:00:00' ? "Didn't clock out" : record.last_out;

                        html += `
                            <tr>
                                <td>${record.shift_date}</td>
                                ${index === 0 && empData.attendance[1] && empData.attendance[1].shift_date === record.shift_date ? `<td rowspan="${empData.attendance.filter(r => r.shift_date === record.shift_date).length}">${empId}</td>` : `<td>${empId}</td>`}
                                ${index === 0 && empData.attendance[1] && empData.attendance[1].shift_date === record.shift_date ? `<td rowspan="${empData.attendance.filter(r => r.shift_date === record.shift_date).length}">${empData.emp_name}</td>` : `<td>${empData.emp_name}</td>`}
                                ${index === 0 && empData.attendance[1] && empData.attendance[1].shift_date === record.shift_date ? `<td rowspan="${empData.attendance.filter(r => r.shift_date === record.shift_date).length}">${empData.grade || 'N/A'}</td>` : `<td>${empData.grade || 'N/A'}</td>`}
                                ${index === 0 && empData.attendance[1] && empData.attendance[1].shift_date === record.shift_date ? `<td rowspan="${empData.attendance.filter(r => r.shift_date === record.shift_date).length}">${empData.designation || 'N/A'}</td>` : `<td>${empData.designation || 'N/A'}</td>`}
                                <td>${firstIn}</td>
                                <td>${lastOut}</td>
                                <td>${record.status}</td>
                                <td>${newawh1} hr/s ${newawh2} min/s</td>
                                <td>${newot1} hr/s ${newot2} min/s</td>
                            </tr>
                        `;
                    });
                }

                html += '</tbody></table>';
            }
        }
    }

    container.innerHTML = html;
}

// ${index === 0 ? `<td rowspan="${empData.attendance.length}">${empId}</td>` : ''}
//                                 ${index === 0 ? `<td rowspan="${empData.attendance.length}">${empData.emp_name}</td>` : ''}
//                                 ${index === 0 ? `<td rowspan="${empData.attendance.length}">${empData.grade || 'N/A'}</td>` : ''}
//                                 ${index === 0 ? `<td rowspan="${empData.attendance.length}">${empData.designation || 'N/A'}</td>` : ''}
//                                 <td>${record.shift_date}</td>

        function printDivAsPDF(divId) {
            const { jsPDF } = window.jspdf;
            const divElement = document.getElementById(divId);
        
            html2canvas(divElement, { scale: 1 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const imgWidth = pageWidth;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
        
                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
        
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
        
                doc.save('div-content.pdf');
            }).catch(error => {
                console.error('Error generating PDF:', error);
            });
        }
        


document.getElementById('btn-export').addEventListener('click', async () => {
    const div = document.getElementById('reportDataContainer');
    const elements = div.querySelectorAll('h1, h2, h3, h4, p, table, img');

    // Initialize workbook and worksheet
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('General Attendance Report');

    // Define styles
    const styles = {
        h1: { font: { size: 24, bold: true } },
        h2: { font: { size: 20, bold: true } },
        h3: { font: { size: 18, bold: true } },
        h4: { font: { size: 16, bold: true } },
        p: { font: { size: 12 } },
        tableHeader: { 
            font: { bold: true }, 
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'C0C0C0' } } 
        }
    };

    async function getBase64Image(url) {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    function formatExcelDate(serial) {
        const utcDays = Math.floor(serial - 25569);
        const utcValue = utcDays * 86400;
        const dateInfo = new Date(utcValue * 1000);

        const fractionalDay = serial - Math.floor(serial) + 0.0000001;
        let totalSeconds = Math.floor(86400 * fractionalDay);

        const seconds = totalSeconds % 60;
        totalSeconds -= seconds;

        const hours = Math.floor(totalSeconds / (60 * 60));
        const minutes = Math.floor(totalSeconds / 60) % 60;

        return new Date(dateInfo.getFullYear(), dateInfo.getMonth(), dateInfo.getDate(), hours, minutes, seconds);
    }

    function isSerialDate(value) {
        return typeof value === 'number' && value > 40000; // Some threshold for likely dates
    }

    // Embed the image at the top
    const imgElement = div.querySelector('img');
    if (imgElement) {
        const imgData = await getBase64Image(imgElement.src);

        const image = workbook.addImage({
            base64: imgData,
            extension: 'png',
        });

        worksheet.addImage(image, {
            tl: { col: 0, row: 0 },
            ext: { width: 500, height: 200 }
        });
    }

    // Start adding other elements from row 12
    let rowOffset = 12;

    elements.forEach(element => {
        if (element.tagName === 'TABLE') {
            const tableData = XLSX.utils.sheet_to_json(XLSX.utils.table_to_sheet(element), { header: 1 });

            tableData.forEach((row, rowIndex) => {
                const rowNum = rowOffset + rowIndex;
                const excelRow = worksheet.getRow(rowNum);

                row.forEach((cell, colIndex) => {
                    const cellRef = excelRow.getCell(colIndex + 1);
                    
                    if (isSerialDate(cell)) {
                        cellRef.value = formatExcelDate(cell).toISOString().split('T')[0];
                    } else {
                        cellRef.value = cell;
                    }

                    // Apply header style
                    if (rowIndex === 0) {
                        cellRef.style = styles.tableHeader;
                    }
                });
                excelRow.height = undefined; // Let the row auto-fit its content
                excelRow.commit();
            });

            // Add an empty row after table
            rowOffset += tableData.length + 1;
        } else if (element.tagName.startsWith('H') || element.tagName === 'P') {
            const rowNum = rowOffset++;
            const row = worksheet.getRow(rowNum);
            row.getCell(1).value = element.innerText;

            // Apply text styles
            const tag = element.tagName.toLowerCase();
            if (styles[tag]) {
                row.getCell(1).style = styles[tag];
            }
            row.height = undefined; // Let the row auto-fit its content
            row.commit();
        }
    });

    // Auto fit columns width
    worksheet.columns.forEach(column => {
        let maxLength = 0;
        column.eachCell({ includeEmpty: true }, cell => {
            const length = cell.value ? cell.value.toString().length : 10;
            if (length > maxLength) {
                maxLength = length;
            }
        });
        column.width = maxLength + 2; // Add some padding

    });

    // Save workbook to file
    const buf = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buf], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'General Attendance Report.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
});






    // Function to check if a value is a date
    function isDate(value) {
        // Check if the value is a number and within a reasonable date range
        return !isNaN(value) && value > 25569 && value < 2958465; // Excel date range
    }
    
    // Function to format dates
    function formatDate(excelDate) {
        const date = new Date((excelDate - 25569) * 86400 * 1000);
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0'); // Months are zero-based
        const year = date.getUTCFullYear();
        return `${year}-${month}-${day}`;
    }
    





    document.getElementById('triggerSync').addEventListener('click', async () => {
        try {
          const response = await fetch('/api/trigger-sync', { method: 'POST' });
          const data = await response.json();
          alert(data.message);
        } catch (error) {
          console.error('Error triggering sync:', error);
          alert('Failed to trigger data synchronization');
        }
      });

      document.getElementById('jumpPageButton').addEventListener('click', () => {
        const totalPages = parseInt(document.getElementById('totalPages').textContent, 10);
        let jumpPage = parseInt(document.getElementById('jumpPageInput').value, 10);
        
        if (jumpPage >= 1 && jumpPage <= totalPages) {
            currentPage = jumpPage;
            fetchGARReport(currentPage, limit);
        } else {
            alert('Please enter a valid page number.');
        }
    });
    





// Inside your <script> tag in the HTML

    let currentPage = 1;
    const limit = 30; // Must match the default limit in backend
    
    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            fetchGARReport(currentPage, limit);
        }
    });
    
    document.getElementById('nextPage').addEventListener('click', () => {
        currentPage++;
        fetchGARReport(currentPage, limit);
    });
    
    async function fetchGARReport(page = 1, limit = 30) {
        const loadingSpinner = document.getElementById('loadingSpinner');
        loadingSpinner.style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
        
        try {
            const filters = {
                dateFrom: document.getElementById('dateFrom').value,
                dateTo: document.getElementById('dateTo').value,
                empId: document.getElementById('empId').value,
                empName: document.getElementById('empName').value,
                department: document.getElementById('department').value,
                site: document.getElementById('site').value,
                nationality: document.getElementById('nationality').value
            };
    
            logDebug('Fetching report with filters and pagination', { filters, page, limit });
    
            // Only include non-empty filters in the query string
            const queryParams = new URLSearchParams(
                Object.fromEntries(
                    Object.entries(filters).filter(([_, v]) => v !== '')
                )
            );
            queryParams.append('page', page);
            queryParams.append('limit', limit);
            const queryString = queryParams.toString();
    
            const response = await fetch(`/api/attendance-report${queryString ? `?${queryString}` : ''}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            logDebug('Received report data', data);
    
            displayReport(data.report);
            document.getElementById('printButton').style.display = 'block';
            document.getElementById('btn-export').style.display = 'block';
            document.getElementById('paginationControls').style.display = 'block';
    
            // Update pagination controls
            const totalPages = Math.ceil(data.totalRecords / limit);
            document.getElementById('currentPage').textContent = data.page;
            document.getElementById('totalPages').textContent = totalPages;
    
            // Show or hide pagination controls based on total pages
            const paginationControls = document.getElementById('paginationControls');
            if (totalPages > 1) {
                paginationControls.style.display = 'block';
            } else {
                paginationControls.style.display = 'none';
            }
    
            logDebug('Report displayed successfully');
        } catch (error) {
            showError('Error fetching report', error);
            document.getElementById('reportContainer').innerHTML = '<p>Error fetching report. Please try again.</p>';
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }
    
    function resetFilters() {
        logDebug('Resetting all filters');
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('empId').value = '';
        document.getElementById('empName').value = '';
        document.getElementById('department').value = '';
        document.getElementById('site').value = '';
        document.getElementById('nationality').value = '';
        currentPage = 1; // Reset to first page
    
        // Fetch report without filters after reset
        fetchGARReport(currentPage, limit);
    }
    





    </script>


</body>
</html>