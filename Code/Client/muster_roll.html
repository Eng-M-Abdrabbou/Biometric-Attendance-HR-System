<!DOCTYPE html>
<html>
<head>
  <title>Muster Roll Report</title>
  <style>
    table {
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
    }
    #loading-message {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Muster Roll Report</h1>
  <button id="view-report-button">View Report</button>

  <input id="month-filter" type="month" placeholder="Month">
  <select id="status-filter">
    <option value="">All</option>
    <option value="Present">Present</option>
    <option value="MS (Miss Swipe)">MS (Miss Swipe)</option>
    <option value="Absent">Absent</option>
  </select>

  <p id="loading-message">Loading report...</p>

  <table id="muster-roll-table">
    <thead>
      <tr>
        <th>Employee ID</th>
        <th>Employee Name</th>
        <th>Shift Date</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="muster-roll-body">
    </tbody>
  </table>

  <script>
    const viewReportButton = document.getElementById('view-report-button');
    const musterRollBody = document.getElementById('muster-roll-body');
    const monthFilter = document.getElementById('month-filter');
    const statusFilter = document.getElementById('status-filter');
    const loadingMessage = document.getElementById('loading-message');

    let reportData = [];

    function filterReportData(month, status) {
      return reportData.filter(item => {
        let statusText = '';
        if (item.clock_in && item.clock_out) {
          statusText = 'Present';
        } else if (item.clock_in || item.clock_out) {
          statusText = 'MS (Miss Swipe)';
        } else {
          statusText = 'Absent';
        }

        return (month === '' || item.shift_date.startsWith(month)) &&
          (status === '' || statusText === status);
      });
    }

function renderReport(data) {
  if (data.length === 0) {
    musterRollBody.innerHTML = '<tr><td colspan="4">No data found</td></tr>';
    return;
  }

  musterRollBody.innerHTML = ''; // Clear the table body

  data.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.emp_id}</td>
      <td>${item.emp_name}</td>
      <td>${item.shift_date}</td>
      <td>${getStatusText(item)}</td>
    `;
    musterRollBody.appendChild(row);
  });
}

    function getStatusText(item) {
      if (item.clock_in && item.clock_out) {
        return 'Present';
      } else if (item.clock_in || item.clock_out) {
        return 'MS (Miss Swipe)';
      } else {
        return 'Absent';
      }
    }

 function fetchReport() {
   console.log('Fetching report data...');
   loadingMessage.style.display = 'block';
   fetch('/fetch-muster-roll')
     .then(response => {
       console.log('Received response:', response);
       if (!response.ok) {
         throw new Error(`HTTP error! status: ${response.status}`);
       }
       return response.json();
     })
     .then(data => {
       console.log('Received data:', data);
       reportData = data;
       renderReport(reportData);
       loadingMessage.style.display = 'none';
     })
     .catch(error => {
       console.error('Error fetching report data:', error);
       loadingMessage.style.display = 'none';
       musterRollBody.innerHTML = '<tr><td colspan="4">Error fetching data</td></tr>';
     });
 }

    viewReportButton.addEventListener('click', fetchReport);

    monthFilter.addEventListener('input', () => {
      renderReport(filterReportData(monthFilter.value, statusFilter.value));
    });

    statusFilter.addEventListener('change', () => {
      renderReport(filterReportData(monthFilter.value, statusFilter.value));
    });
  </script>
</body>
</html>
