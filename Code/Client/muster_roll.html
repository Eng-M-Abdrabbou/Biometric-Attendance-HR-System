<!DOCTYPE html>
<html>
<head>
  <title>Muster Roll Report</title>
  <style>
    table {
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
    }
    #loading-message {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Muster Roll Report</h1>
  <button id="view-report-button">View Report</button>

  <input id="id-filter" type="text" placeholder="ID">
  <input id="name-filter" type="text" placeholder="Name">
  <input id="date-filter" type="date" placeholder="Date">
  <select id="status-filter">
    <option value="">All</option>
    <option value="Present">Present</option>
    <option value="MS (Miss Swipe)">MS (Miss Swipe)</option>
    <option value="Absent">Absent</option>
  </select>

  <p id="loading-message">Loading report...</p>

  <table id="muster-roll-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Employee ID</th>
        <th>Employee Name</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="muster-roll-body">
    </tbody>
  </table>

  <script>
    const viewReportButton = document.getElementById('view-report-button');
    const musterRollBody = document.getElementById('muster-roll-body');
    const idFilter = document.getElementById('id-filter');
    const nameFilter = document.getElementById('name-filter');
    const dateFilter = document.getElementById('date-filter');
    const statusFilter = document.getElementById('status-filter');
    const loadingMessage = document.getElementById('loading-message');

    viewReportButton.addEventListener('click', () => {
      // First, fill the muster roll table
      fetch('/fill-muster-roll-table')
        .then(response => response.text())

        .then(() => {
          // Then, fetch the data for the report
          const id = idFilter.value;
          const name = nameFilter.value;
          const date = dateFilter.value;
          const status = statusFilter.value;
          loadingMessage.style.display = 'block';
          fetch(`/fetch-muster-roll?id=${id}&name=${name}&date=${date}&status=${status}`)
            .then(response => response.json())
            .then(data => {
              loadingMessage.style.display = 'none';
              console.log(data);
              musterRollBody.innerHTML = ''; // Clear the table body
              data.forEach(item => {
                let statusText = '';
                if (item.clock_in && item.clock_out) {
                  statusText = 'Present';
                } else if (item.clock_in || item.clock_out) {
                  statusText = 'MS (Miss Swipe)';
                } else {
                  statusText = 'Absent';
                }

                if ((id === '' || item.emp_id == id) &&
                    (name === '' || item.emp_name.includes(name)) &&
                    (date === '' || item.shift_date === date) &&
                    (status === '' || statusText === status)) {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td>${item.shift_date}</td>
                    <td>${item.emp_id}</td>
                    <td>${item.emp_name}</td>
                    <td>${statusText}</td>
                  `;
                  musterRollBody.appendChild(row);
                }
              });
            });
        });
    });
  </script>
</body>
</html>