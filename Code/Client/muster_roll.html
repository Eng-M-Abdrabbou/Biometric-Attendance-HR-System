<!DOCTYPE html>
<html>
<head>
  <title>Muster Roll Report</title>
  <style>
    table {
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1>Muster Roll Report</h1>
  <button id="view-report-button">View Report</button>

  <label for="date-filter">Date:</label>
  <input type="date" id="date-filter">

  <label for="emp_id-filter">Employee ID:</label>
  <input type="text" id="emp_id-filter">

  <label for="status-filter">Status:</label>
  <select id="status-filter">
    <option value="">All</option>
    <option value="Present">Present</option>
    <option value="MS (Miss Swipe)">MS (Miss Swipe)</option>
    <option value="Absent">Absent</option>
  </select>

  <button id="filter-button">Filter</button>

  <table id="muster-roll-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Employee ID</th>
        <th>Employee Name</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="muster-roll-body">
    </tbody>
  </table>

  <script>
    const viewReportButton = document.getElementById('view-report-button');
    const filterButton = document.getElementById('filter-button');
    const musterRollTable = document.getElementById('muster-roll-table');
    const musterRollBody = document.getElementById('muster-roll-body');
    const dateFilter = document.getElementById('date-filter');
    const emp_idFilter = document.getElementById('emp_id-filter');
    const statusFilter = document.getElementById('status-filter');

    viewReportButton.addEventListener('click', () => {
      fetch('/fill-muster-roll-table')
        .then(response => response.text())
        .then(() => {
          fetch('/get-muster-roll-data')
            .then(response => response.json())
            .then(data => {
              const musterRollData = data;
              console.log(musterRollData);
              musterRollBody.innerHTML = ''; // clear the table body

              const uniqueDates = [...new Set(musterRollData.map(item => item.shift_date))];

              uniqueDates.forEach(date => {
                const dateData = musterRollData.filter(item => item.shift_date === date);

                const dateRow = document.createElement('tr');
                dateRow.innerHTML = `
                  <td>${date}</td>
                  <td colspan="3">**${date}**</td>
                `;
                musterRollBody.appendChild(dateRow);

                dateData.forEach(item => {
                  let status = '';
                  if (item.clock_in && item.clock_out) {
                    status = 'Present';
                  } else if (item.clock_in || item.clock_out) {
                    status = 'MS (Miss Swipe)';
                  } else {
                    status = 'Absent';
                  }

                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td>${item.shift_date}</td>
                    <td>${item.emp_id}</td>
                    <td>${item.emp_name}</td>
                    <td>${status}</td>
                  `;
                  musterRollBody.appendChild(row);
                });
              });
            })
            .catch(error => console.error('Error:', error));
        })
        .catch(error => console.error('Error:', error));
    });

    filterButton.addEventListener('click', updateTable);

   function updateTable() {
     const date = dateFilter.value;
     const emp_id = emp_idFilter.value;
     const status = statusFilter.value;
     console.log("filters values ", date, emp_id, status);
   
     fetch(`/get-muster-roll-data?date=${date}&emp_id=${emp_id}`)
       .then(response => response.json())
       .then(data => {
         const filteredData = data.filter(item => {
           const dateMatch = date === '' || item.shift_date === date;
           const empIdMatch = emp_id === '' || item.emp_id === parseInt(emp_id); // Convert emp_id to integer
   
           return dateMatch && empIdMatch;
         });
   
         musterRollBody.innerHTML = ''; // clear the table body
   
         if (filteredData.length > 0) {
           filteredData.forEach(item => {
             let status = '';
             if (item.clock_in && item.clock_out) {
               status = 'Present';
             } else if (item.clock_in || item.clock_out) {
               status = 'MS (Miss Swipe)';
             } else {
               status = 'Absent';
             }
   
             const row = document.createElement('tr');
             row.innerHTML = `
               <td>${item.shift_date}</td>
               <td>${item.emp_id}</td>
               <td>${item.emp_name}</td>
               <td>${status}</td>
             `;
             musterRollBody.appendChild(row);
           });
         } else { // No data found
           const noDataRow = document.createElement('tr');
           noDataRow.innerHTML = `
             <td colspan="4">No data found</td>
           `;
           musterRollBody.appendChild(noDataRow);
         }
       })
       .catch(error => console.error('Error:', error));
   }
  </script> 

</body>
</html>