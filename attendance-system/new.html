<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Your existing styles remain unchanged */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        h2 {
            background-color: #943240;
            color: white;
            padding: 20px;
            margin: -20px -20px 30px -20px;
            font-size: 24px;
        }

        .controls-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .date-controls, .distribution-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        label {
            font-weight: 500;
            color: #666;
        }

        input[type="date"], select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            color: white;
            background-color: #943240;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #7a2a35;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            

            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-title {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <h2>Attendance Summary</h2>

    <div class="controls-container">
        <div class="date-controls">
            <label for="startDate">Start Date:</label>
            <input type="date" id="startDate" required>
            <label for="endDate">End Date:</label>
            <input type="date" id="endDate" required>
            <button onclick="fetchAndRenderAttendance()">Show Attendance</button>
        </div>
        <div class="distribution-controls">
            <label for="distributionType">Distribution Type:</label>
            <select id="distributionType">
                <option value="nationality">Nationality</option>
                <option value="department">Department</option>
                <option value="location">Location</option>
            </select>
            <button onclick="fetchAndDisplayDistribution()">Show Distribution</button>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h3 class="chart-title">Attendance Distribution</h3>
            <canvas id="attendanceChart"></canvas>
        </div>
        <div class="chart-container">
            <h3 class="chart-title" id="distributionChartTitle">Distribution Chart</h3>
            <canvas id="distributionChart"></canvas>
        </div>
    </div>

    <script>
        // const nationalitfyMap = {
        //     1: 'India',
        //     2: 'Turkey',
        //     3: 'United Arab',
        //     4: 'Nepal',
        //     5: 'Egypt',
        //     6: 'Bangladesh',
        //     7: 'Pakistan',
        //     8: 'Canada',
        //     9: 'Jordan',
        //     10: 'Oman',
        //     11: 'United Kingdom'
        // };

        let attendanceChart;
        let distributionChart;

        async function fetchAttendanceData(startDate, endDate) {
            const response = await fetch(`http://localhost:3000/api/attendance?startDate=${startDate}&endDate=${endDate}`);
            const data = await response.json();
            return data;
        }

/*        async function fetchAndRenderAttendance() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }

            const { present, absent, Ms } = await fetchAttendanceData(startDate, endDate);

            if (!attendanceChart) {
                const ctx = document.getElementById('attendanceChart').getContext('2d');
                attendanceChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Present', 'Absent', 'Ms'],
                        datasets: [{
                            data: [present, absent, Ms],
                            backgroundColor: ['#4CAF50', '#FF5733', '#FFC300']
                        }]
                    }
                });
            } else {
             //   attendanceChart.data.datasets[0].data = [present, absent, M];
             //   attendanceChart.update();
                distributionChart.data.labels = labels;
                distributionChart.data.datasets[0].data = counts;
                distributionChart.data.datasets[0].backgroundColor = generateColors(counts.length);
                distributionChart.update();
            }
        }
*/


async function fetchAndRenderAttendance() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
    }

    const { present, absent, Ms } = await fetchAttendanceData(startDate, endDate);

    if (!attendanceChart) {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        attendanceChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Present', 'Absent', 'Ms'],
                datasets: [{
                    data: [present, absent, Ms],
                    backgroundColor: ['#4CAF50', '#FF5733', '#FFC300']
                }]
            }
        });
    } else {
        attendanceChart.data.datasets[0].data = [present, absent, Ms];
        attendanceChart.update();
    }
}



async function fetchAndDisplayDistribution() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const distributionType = document.getElementById('distributionType').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }

            const response = await fetch(`http://localhost:3000/api/attendance-distribution?startDate=${startDate}&endDate=${endDate}&type=${distributionType}`);
            const data = await response.json();

            const labels = data.map(item => item.label);
            const counts = data.map(item => item.count);

            document.getElementById('distributionChartTitle').innerText = `${distributionType.charAt(0).toUpperCase() + distributionType.slice(1)} Distribution`;

            if (!distributionChart) {
                const ctx = document.getElementById('distributionChart').getContext('2d');
                distributionChart = new Chart(ctx, {
                    type: 'pie', // Changed from 'bar' to 'pie'
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: generateColors(counts.length)
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            } else {
                distributionChart.data.labels = labels;
                distributionChart.data.datasets[0].data = counts;
                distributionChart.data.datasets[0].backgroundColor = generateColors(counts.length);
                distributionChart.update();
            }
        }

        function generateColors(count) {
            const colors = ['#943240', '#4CAF50', '#FFC300', '#FF5733', '#8E44AD', '#3498DB', '#1ABC9C', '#F39C12', '#e74c3c', '#2ecc71', '#e67e22'];
            return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
        }
    </script>
</body>
</html>